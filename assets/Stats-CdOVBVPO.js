import{n as v,r as c,j as g,a as R,b as E,e as O,f as l,d as $}from"./index-JV1Y47JS.js";import{f as B}from"./fetchAllUsers-BUmRFRx-.js";import{A as G,g as N,M as W,V as _,N as F,C as j,b as I,a as L,L as U}from"./gridTheme-BTmQ8vKy.js";import{s as b,e as k,a as C,b as z}from"./endOfWeek-C69AD0Ki.js";function P(e,t,n){const[o,s]=v(n==null?void 0:n.in,e,t);return o.getFullYear()===s.getFullYear()&&o.getMonth()===s.getMonth()}const V={loadingOoo:"Загрузка...",inRange:"Значение между",inRangeStart:"Больше",inRangeEnd:"Меньше",applyFilter:"Применить",resetFilter:"Сброс"};W.registerModules([_,F,j,I,L,U]);const Y="https://inforgiy-server.fly.dev";async function D(e,t,n){try{return(await R.post(`${Y}/api/stats`,{branch:e,user_ids:t,dateRanges:n})).data}catch(o){E(o)}}function q(e){const t=[];t.push([l(new Date(e,0,1),"yyyy-MM-dd"),l(new Date(e,11,31),"yyyy-MM-dd")]);const n=Array.from({length:12},(o,s)=>s);for(const o of n){const s=b(new Date(e,o)),r=k(new Date(e,o));t.push([l(s,"yyyy-MM-dd"),l(r,"yyyy-MM-dd")])}return t}function H(e){const t=[],n=Array.from({length:12},(s,r)=>r),o={field:`${e}`,openByDefault:!0,children:[]};for(const s of n){const r=[],u=b(new Date(e,s)),m=k(new Date(e,s));let a=O(u,{weekStartsOn:1});for(;a<=m;){P(a,u)||(a=C(a,1));let y=z(a,{weekStartsOn:1});r.push({field:`${l(a,"yyyy-MM-dd")}_${l(y,"yyyy-MM-dd")}`,headerName:`${l(a,"dd.MM")} - ${l(y,"dd.MM")}`,columnGroupShow:"open"}),a=C(a,1)}r.push({field:`${l(u,"yyyy-MM-dd")}_${l(m,"yyyy-MM-dd")}`,headerName:"Итого",columnGroupShow:"closed"}),o.children.push({field:l(u,"yyyy-MM"),headerName:l(u,"LLLL",{locale:$}),columnGroupShow:"open",children:r})}return o.children.push({field:`${l(new Date(e,0,1),"yyyy-MM-dd")}_${l(new Date(e,11,31),"yyyy-MM-dd")}`,headerName:"Итого",columnGroupShow:"closed"}),t.push(o),t}function x(e){const t=[];for(const[n,o]of Object.entries(e)){const s={user:n};for(const r of o){const u=`${r.dateRange[0].split("T")[0]}_${r.dateRange[1].split("T")[0]}`;s[u]=r.count}t.push(s)}return{rows:t}}const J=e=>{var t,n,o,s;if(e.value<=0&&((n=(t=e.column)==null?void 0:t.originalParent)==null?void 0:n.expanded)===!0&&((s=(o=e.column)==null?void 0:o.originalParent)==null?void 0:s.expandable)===!0)return"text-[#ff0000]"};function K({branch:e,initDataUnsafe:t}){const[n,o]=c.useState(null),[s,r]=c.useState(null),[u,m]=c.useState(null),[a]=c.useState({sortable:!0,filter:"agNumberColumnFilter",filterParams:{filterOptions:["inRange"],inRangeInclusive:!0,buttons:["apply","reset"],closeOnApply:!0,maxNumConditions:1},suppressMovable:!0,wrapText:!0,cellClass:J});c.useEffect(()=>{document.body.dataset.agThemeMode=window.Telegram.WebApp.colorScheme},[]);const y=c.useMemo(()=>({type:"fitCellContents"}),[]),A=c.useCallback(async f=>{if(f.columnGroup.level===1&&f.columnGroup.isExpanded()===!0){const d=[];for(const p of f.columnGroup.children){const i=p.colId.split("_");d.push([i[0],i[1]])}const h=await D(e,n,d),{rows:M}=x(h);m(p=>p.map(i=>{const w=M.find(S=>S.user===i.user);return w?{...i,...w}:i}))}if(f.columnGroup.isExpanded()===!0){const d=f.columnGroup.children.map(h=>h.getId());f.api.autoSizeColumns(d)}},[e,n]);return c.useEffect(()=>{(async()=>{try{const d=new Date().getFullYear(),M=(await B(e,t)).map(T=>T.id),p=H(d),i=q(d),w=await D(e,M,i),{rows:S}=x(w);o(M),m(S),r([{field:"user",headerName:"Позывной",pinned:"left",filter:null,cellClass:null},...p])}catch{}})()},[e,t]),g.jsx(G,{rowData:u,columnDefs:s,defaultColDef:a,onColumnGroupOpened:A,autoSizeStrategy:y,suppressColumnVirtualisation:!0,localeText:V,gridOptions:{theme:N}})}function te({branch:e,initDataUnsafe:t,setShowStats:n}){return c.useEffect(()=>(window.Telegram.WebApp.BackButton.onClick(()=>{n(!1)}),window.Telegram.WebApp.BackButton.show(),()=>{window.Telegram.WebApp.BackButton.offClick(),window.Telegram.WebApp.BackButton.hide()}),[n]),g.jsx("div",{className:"w-full h-full flex flex-col fixed inset-0 bg-gray-white dark:bg-neutral-900",children:g.jsx("div",{className:"w-full h-full flex-1 overflow-hidden",children:g.jsx(K,{branch:e,initDataUnsafe:t})})})}export{te as default};
