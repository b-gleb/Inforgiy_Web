import{n as R,r as c,j as g,a as v,b as E,e as O,f as r,d as $}from"./index-DdIY_2Ug.js";import{f as B}from"./fetchAllUsers-n_a76Rv5.js";import{A as G,g as N,M as W,V as _,N as F,C as j,b as I,L}from"./gridTheme-CU8msR84.js";import{s as x,e as k,a as D,b as U}from"./endOfWeek-BorkYwWV.js";function z(e,t,n){const[o,s]=R(n==null?void 0:n.in,e,t);return o.getFullYear()===s.getFullYear()&&o.getMonth()===s.getMonth()}const V={loadingOoo:"Загрузка...",inRange:"Значение между",inRangeStart:"Больше",inRangeEnd:"Меньше",applyFilter:"Применить",resetFilter:"Сброс"};W.registerModules([_,F,j,I,L]);const Y="https://inforgiy-server.fly.dev";async function C(e,t,n){try{return(await v.post(`${Y}/api/stats`,{branch:e,user_ids:t,dateRanges:n})).data}catch(o){E(o)}}function P(e){const t=[];t.push([r(new Date(e,0,1),"yyyy-MM-dd"),r(new Date(e,11,31),"yyyy-MM-dd")]);const n=Array.from({length:12},(o,s)=>s);for(const o of n){const s=x(new Date(e,o)),a=k(new Date(e,o));t.push([r(s,"yyyy-MM-dd"),r(a,"yyyy-MM-dd")])}return t}function q(e){const t=[],n=Array.from({length:12},(s,a)=>a),o={field:`${e}`,openByDefault:!0,children:[]};for(const s of n){const a=[],u=x(new Date(e,s)),m=k(new Date(e,s));let l=O(u,{weekStartsOn:1});for(;l<=m;){z(l,u)||(l=D(l,1));let y=U(l,{weekStartsOn:1});a.push({field:`${r(l,"yyyy-MM-dd")}_${r(y,"yyyy-MM-dd")}`,headerName:`${r(l,"dd.MM")} - ${r(y,"dd.MM")}`,columnGroupShow:"open"}),l=D(l,1)}a.push({field:`${r(u,"yyyy-MM-dd")}_${r(m,"yyyy-MM-dd")}`,headerName:"Итого",columnGroupShow:"closed"}),o.children.push({field:r(u,"yyyy-MM"),headerName:r(u,"LLLL",{locale:$}),columnGroupShow:"open",children:a})}return o.children.push({field:`${r(new Date(e,0,1),"yyyy-MM-dd")}_${r(new Date(e,11,31),"yyyy-MM-dd")}`,headerName:"Итого",columnGroupShow:"closed"}),t.push(o),t}function b(e){const t=[];for(const[n,o]of Object.entries(e)){const s={user:n};for(const a of o){const u=`${a.dateRange[0].split("T")[0]}_${a.dateRange[1].split("T")[0]}`;s[u]=a.count}t.push(s)}return{rows:t}}function H({branch:e,initDataUnsafe:t}){const[n,o]=c.useState(null),[s,a]=c.useState(null),[u,m]=c.useState(null),[l]=c.useState({sortable:!0,filter:"agNumberColumnFilter",filterParams:{filterOptions:["inRange"],inRangeInclusive:!0,buttons:["apply","reset"],closeOnApply:!0,maxNumConditions:1},suppressMovable:!0,wrapText:!0});c.useEffect(()=>{document.body.dataset.agThemeMode=window.Telegram.WebApp.colorScheme},[]);const y=c.useMemo(()=>({type:"fitCellContents"}),[]),A=c.useCallback(async f=>{if(f.columnGroup.level===1&&f.columnGroup.isExpanded()===!0){const d=[];for(const p of f.columnGroup.children){const i=p.colId.split("_");d.push([i[0],i[1]])}const h=await C(e,n,d),{rows:M}=b(h);m(p=>p.map(i=>{const w=M.find(S=>S.user===i.user);return w?{...i,...w}:i}))}if(f.columnGroup.isExpanded()===!0){const d=f.columnGroup.children.map(h=>h.getId());f.api.autoSizeColumns(d)}},[e,n]);return c.useEffect(()=>{(async()=>{try{const d=new Date().getFullYear(),M=(await B(e,t)).map(T=>T.id),p=q(d),i=P(d),w=await C(e,M,i),{rows:S}=b(w);o(M),m(S),a([{field:"user",headerName:"Позывной",filter:null,pinned:"left"},...p])}catch{}})()},[e,t]),g.jsx(G,{rowData:u,columnDefs:s,defaultColDef:l,onColumnGroupOpened:A,autoSizeStrategy:y,suppressColumnVirtualisation:!0,localeText:V,gridOptions:{theme:N}})}function Z({branch:e,initDataUnsafe:t,setShowStats:n}){return c.useEffect(()=>(window.Telegram.WebApp.BackButton.onClick(()=>{n(!1)}),window.Telegram.WebApp.BackButton.show(),()=>{window.Telegram.WebApp.BackButton.offClick(),window.Telegram.WebApp.BackButton.hide()}),[n]),g.jsx("div",{className:"w-full h-full flex flex-col fixed inset-0 bg-gray-white dark:bg-neutral-900",children:g.jsx("div",{className:"w-full h-full flex-1 overflow-hidden",children:g.jsx(H,{branch:e,initDataUnsafe:t})})})}export{Z as default};
