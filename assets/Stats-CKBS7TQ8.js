import{e as R,t as D,n as _,r as c,j as h,a as v,b as E,g as $,f as a,d as B}from"./index-Bk3Ar8EO.js";import G from"./personalStats-Ca40gwqU.js";import{f as N}from"./fetchAllUsers-CrMeDmcq.js";import{A as F,g as W,M as j,V as I,N as L,C as U,b as Y,L as z}from"./gridTheme-Lk36UMFT.js";function C(t,e,n){return R(t,e*7,n)}function b(t,e){const n=D(t,e==null?void 0:e.in),r=n.getMonth();return n.setFullYear(n.getFullYear(),r+1,0),n.setHours(23,59,59,999),n}function A(t,e){const n=D(t,e==null?void 0:e.in);return n.setDate(1),n.setHours(0,0,0,0),n}function H(t,e){const n=e==null?void 0:e.weekStartsOn,r=D(t,e==null?void 0:e.in),s=r.getDay(),o=(s<n?-7:0)+6-(s-n);return r.setDate(r.getDate()+o),r.setHours(23,59,59,999),r}function V(t,e,n){const[r,s]=_(n==null?void 0:n.in,t,e);return r.getFullYear()===s.getFullYear()&&r.getMonth()===s.getMonth()}const P={loadingOoo:"Загрузка...",inRange:"Значение между",inRangeStart:"Больше",inRangeEnd:"Меньше",applyFilter:"Применить",resetFilter:"Сброс"};j.registerModules([I,L,U,Y,z]);const q="https://inforgiy-server.fly.dev";async function x(t,e,n){try{return(await v.post(`${q}/api/stats`,{branch:t,user_ids:e,dateRanges:n})).data}catch(r){E(r)}}function J(t){const e=[];e.push([a(new Date(t,0,1),"yyyy-MM-dd"),a(new Date(t,11,31),"yyyy-MM-dd")]);const n=Array.from({length:12},(r,s)=>s);for(const r of n){const s=A(new Date(t,r)),o=b(new Date(t,r));e.push([a(s,"yyyy-MM-dd"),a(o,"yyyy-MM-dd")])}return e}function K(t){const e=[],n=Array.from({length:12},(s,o)=>o),r={field:`${t}`,openByDefault:!0,children:[]};for(const s of n){const o=[],u=A(new Date(t,s)),m=b(new Date(t,s));let l=$(u,{weekStartsOn:1});for(;l<=m;){V(l,u)||(l=C(l,1));let p=H(l,{weekStartsOn:1});o.push({field:`${a(l,"yyyy-MM-dd")}_${a(p,"yyyy-MM-dd")}`,headerName:`${a(l,"dd.MM")} - ${a(p,"dd.MM")}`,columnGroupShow:"open"}),l=C(l,1)}o.push({field:`${a(u,"yyyy-MM-dd")}_${a(m,"yyyy-MM-dd")}`,headerName:"Итого",columnGroupShow:"closed"}),r.children.push({field:a(u,"yyyy-MM"),headerName:a(u,"LLLL",{locale:B}),columnGroupShow:"open",children:o})}return r.children.push({field:`${a(new Date(t,0,1),"yyyy-MM-dd")}_${a(new Date(t,11,31),"yyyy-MM-dd")}`,headerName:"Итого",columnGroupShow:"closed"}),e.push(r),e}function k(t){const e=[];for(const[n,r]of Object.entries(t)){const s={user:n};for(const o of r){const u=`${o.dateRange[0].split("T")[0]}_${o.dateRange[1].split("T")[0]}`;s[u]=o.count}e.push(s)}return{rows:e}}function Q({branch:t,initDataUnsafe:e}){const[n,r]=c.useState(null),[s,o]=c.useState(null),[u,m]=c.useState(null),[l]=c.useState({sortable:!0,filter:"agNumberColumnFilter",filterParams:{filterOptions:["inRange"],inRangeInclusive:!0,buttons:["apply","reset"],closeOnApply:!0,maxNumConditions:1},suppressMovable:!0,wrapText:!0});c.useEffect(()=>{document.body.dataset.agThemeMode=window.Telegram.WebApp.colorScheme},[]);const p=c.useMemo(()=>({type:"fitCellContents"}),[]),O=c.useCallback(async f=>{if(f.columnGroup.level===1&&f.columnGroup.isExpanded()===!0){const d=[];for(const y of f.columnGroup.children){const i=y.colId.split("_");d.push([i[0],i[1]])}const M=await x(t,n,d),{rows:g}=k(M);m(y=>y.map(i=>{const w=g.find(S=>S.user===i.user);return w?{...i,...w}:i}))}if(f.columnGroup.isExpanded()===!0){const d=f.columnGroup.children.map(M=>M.getId());f.api.autoSizeColumns(d)}},[t,n]);return c.useEffect(()=>{(async()=>{try{const d=new Date().getFullYear(),g=(await N(t,e)).map(T=>T.id),y=K(d),i=J(d),w=await x(t,g,i),{rows:S}=k(w);r(g),m(S),o([{field:"user",headerName:"Позывной",filter:null,pinned:"left"},...y])}catch{}})()},[t,e]),h.jsx(F,{rowData:u,columnDefs:s,defaultColDef:l,onColumnGroupOpened:O,autoSizeStrategy:p,suppressColumnVirtualisation:!0,localeText:P,gridOptions:{theme:W}})}function ne({branch:t,initDataUnsafe:e,setShowStats:n}){return c.useEffect(()=>(window.Telegram.WebApp.BackButton.onClick(()=>{n(!1)}),window.Telegram.WebApp.BackButton.show(),()=>{window.Telegram.WebApp.BackButton.offClick(),window.Telegram.WebApp.BackButton.hide()}),[n]),h.jsxs("div",{className:"w-full h-full flex flex-col fixed inset-0 bg-gray-100 dark:bg-neutral-900",children:[h.jsx(G,{branch:t,user_id:e.user.id}),h.jsx("div",{className:"flex-1 overflow-hidden",children:h.jsx(Q,{branch:t,initDataUnsafe:e})})]})}export{ne as default};
