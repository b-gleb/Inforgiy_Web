const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/userSearchPopUp-UJP_y0b9.js","assets/index-Bo4-0vWi.js","assets/index-CNy_Jku-.css","assets/fetchAllUsers-CgEL_J9V.js"])))=>i.map(i=>d[i]);
import{s as F,c as H,r as i,j as e,L,R as V,f as j,a as G,b as P,d as D,A,m as E,u as U,_ as $}from"./index-Bo4-0vWi.js";import{A as q,g as z,M as J,V as K,S as Q,C as X,R as Y,a as Z}from"./gridTheme-D9j8CW8P.js";function ee(t){return F(Date.now(),t)}/**
 * @license lucide-react v0.513.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],se=H("user-plus",te);J.registerModules([K,Q,X,Y,Z]);const ne=i.lazy(()=>$(()=>import("./userSearchPopUp-UJP_y0b9.js"),__vite__mapDeps([0,1,2,3]))),ae=ee();function v(t){const d=t.toString().padStart(2,"0"),f=(t+1).toString().padStart(2,"0");return`${d}:00 - ${f}:00`}function le({branch:t,rotaAdmin:d,maxDuties:f,initDataUnsafe:b,setShowWeekly:x}){const u=n=>{const s=n.value;if(!Array.isArray(s)||s.length===0)return s;const l=s.map(a=>{const o=(a==null?void 0:a.nick.split(" ")[0])??a.username;return t==="gp"&&a.color===1?e.jsx("span",{className:"gp-green",children:o},a.id):o});return e.jsx(e.Fragment,{children:l.map((a,o)=>e.jsxs(V.Fragment,{children:[o>0&&", ",a]},o))})},k=n=>{const s=n.value;if(!Array.isArray(s))return"";if(s.length===0)return t==="gp"?"empty gp":"empty";if(s.some(l=>l.id===b.user.id))return"my-duty"},N=n=>{n.api.ensureColumnVisible(j(new Date,"yyyy-MM-dd"),"start"),m(!1)},M=n=>{n.colDef.field==="index"?x(!1):r({users:(n==null?void 0:n.value)??[],column:n.column,rowNode:n.node})},[g,m]=i.useState(!0),[w,r]=i.useState(null),[y,R]=i.useState([]),[S,T]=i.useState(null),[C]=i.useState({sortable:!1,suppressMovable:!0,width:window.innerWidth*.2,cellRenderer:u,cellClass:k,autoHeight:!0,wrapText:!0}),O=()=>{const n=[],s=new Date,l=s.getDay(),a=new Date(s);a.setDate(s.getDate()-(l+6)%7);for(let o=0;o<25;o++){const h=new Date(a);h.setDate(a.getDate()+o),n.push(h)}return n};function _(n,s){const l=n.map(o=>o.field);return s[0].map((o,h)=>{const c={};return l.forEach((p,B)=>{const I=s[B][h];c[p]=I}),c})}i.useEffect(()=>(window.Telegram.WebApp.BackButton.onClick(()=>{x(!1)}),window.Telegram.WebApp.BackButton.show(),document.body.dataset.agThemeMode=window.Telegram.WebApp.colorScheme,()=>{window.Telegram.WebApp.BackButton.offClick(),window.Telegram.WebApp.BackButton.hide()}),[x]),i.useEffect(()=>{(async()=>{const s=[],l=O();for(const c of l)try{const p=await G.get("/api/rota",{params:{branch:t,date:j(c,"yyyy-MM-dd")}});s.push(p.data)}catch(p){P(p),s.push({})}const a=l.map(c=>({field:j(c,"yyyy-MM-dd"),headerName:j(c,"dd.MM EEEEEE",{locale:D})}));R([{field:"index",pinned:"left",headerName:"",valueGetter:c=>v(c.node.rowIndex),cellRenderer:null,cellStyle:null,cellClass:null},...a]);const o=[];for(const c of s)o.push(c.map(p=>p.users));const h=_(a,o);T(h)})()},[t]);const W=()=>{r(null)};return e.jsxs(e.Fragment,{children:[g&&e.jsx(L,{}),S&&e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(q,{onGridReady:N,rowData:S,columnDefs:y,defaultColDef:C,className:"w-full h-full",getRowHeight:()=>13,onCellClicked:M,gridOptions:{theme:z}})}),e.jsx(oe,{selectedCellData:w,branch:t,rotaAdmin:d,maxDuties:f,setSelectedCellData:r,initDataUnsafe:b,closePopup:W})]})}function oe({selectedCellData:t,branch:d,rotaAdmin:f,maxDuties:b,setSelectedCellData:x,initDataUnsafe:u,closePopup:k}){const[N,M]=i.useState(!1);let g,m;t&&(g=new Date(t.column.colDef.field),m=t.rowNode.rowIndex);const w=async r=>{r.date=t.column.colDef.field,r.timeRange=v(m),U(r).then(y=>{t.rowNode.setDataValue(t.column,y[m].users),x(R=>({...R,users:y[m].users}))}).catch(()=>{})};return e.jsxs(e.Fragment,{children:[e.jsx(A,{children:t&&e.jsx(E.div,{className:"fixed inset-0 bg-black",initial:{opacity:0},animate:{opacity:.5},exit:{opacity:0},onClick:k})}),e.jsx(A,{children:t&&e.jsxs(E.div,{className:"pop-up",initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",stiffness:300,damping:30},children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold dark:text-white",children:"Дежурные"}),e.jsx("button",{className:"pr-2 text-red-500 text-lg font-bold",onClick:k,children:"✕"})]}),e.jsxs("h3",{className:"text-sm font-medium mb-2 text-gray-500",children:[j(g,"EEEE dd.MM",{locale:D}),", ",v(m)]}),e.jsxs("div",{children:[Object.values(t.users).length>0?Object.values(t.users).map((r,y)=>e.jsxs("div",{className:"flex items-center justify-between p-4 mb-2 bg-gray-100 dark:bg-neutral-700 dark:text-gray-400 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:r.nick}),f&&e.jsx("button",{onClick:()=>{w({type:"remove",branch:d,modifyUserId:r.id,initDataUnsafe:u}).then(window.Telegram.WebApp.HapticFeedback.impactOccurred("light")).catch(()=>{})},children:"✕"})]},y)):e.jsx("p",{className:"pb-4 text-center text-gray-500",children:"В это время нет дежурных"}),g>=ae&&!t.users.some(r=>r.id===u.user.id)&&t.users.length<b&&e.jsxs("div",{className:"flex justify-between gap-6",children:[e.jsx("button",{className:"button-primary",onClick:()=>{w({type:"add",branch:d,modifyUserId:u.user.id,initDataUnsafe:u}).then(window.Telegram.WebApp.HapticFeedback.notificationOccurred("success")).catch(()=>{})},children:"Взять смену"}),f&&e.jsx("button",{className:"button-secondary",onClick:()=>{M(!0),window.Telegram.WebApp.HapticFeedback.impactOccurred("light")},children:e.jsx(se,{})})]})]})]})}),N&&e.jsx(i.Suspense,{fallback:null,children:e.jsx(ne,{mode:"rota_weekly",branch:d,initDataUnsafe:u,handleUpdateCell:w,onClose:()=>{M(!1)}})})]})}export{le as default};
